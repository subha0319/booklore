<div class="container">
  <div class="main-card">
    <div class="header">
      <div class="header-content">
        <h2>
          Review Bookdrop Files
          <a href="https://booklore-app.github.io/booklore-docs/docs/bookdrop" target="_blank" rel="noopener noreferrer">
            <i
              class="pi pi-external-link external-link-icon"
              pTooltip="View documentation"
              tooltipPosition="top"></i>
          </a>
        </h2>
        <p>
          These files were uploaded to the
          <strong>Bookdrop Folder</strong>.
          Review their fetched metadata, assign a library and subpath, and finalize where they belong in your collection.
        </p>
      </div>

      <div class="header-actions">
        <p-button
          label="Rescan"
          icon="pi pi-refresh"
          severity="primary"
          outlined
          (click)="rescanBookdrop()"
          pTooltip="Manually trigger a rescan of the Bookdrop folder"
          tooltipPosition="top">
        </p-button>
      </div>
    </div>

    @if (loading) {

      <div class="loading-overlay">
        <div class="loading-content">
          <p-progressSpinner strokeWidth="4"/>
          <span>Loading Bookdrop files. Please wait...</span>
        </div>
      </div>

    } @else {

      <div class="controls-section">
        @if (saving) {
          <div class="saving-overlay">
            <p-progressSpinner strokeWidth="4"/>
            <div class="saving-message">
            <span>
              Organizing and moving files to their designated libraries. Please wait...
            </span>
            </div>
          </div>
        }

        @if (bookdropFileUis.length !== 0) {
          <div class="controls-row">
            <div class="action-buttons">
              <p-button
                size="small"
                outlined
                severity="info"
                label="Import&nbsp;Metadata"
                icon="pi pi-copy"
                (click)="copyAll()"
                pTooltip="Replace current metadata with fetched metadata on all files"
                tooltipPosition="top">
              </p-button>
              <span pTooltip="Include book covers when importing fetched metadata"><p-checkbox
                inputId="includecovers"
                [binary]="true"
                [(ngModel)]="includeCoversOnCopy">
              </p-checkbox>
              <label for="includecovers" class="text-sm" style="margin-left: 0.5em;">Covers</label></span>
            </div>
            
            <div class="default-controls">
              <p-select
                size="small"
                [options]="libraryOptions"
                optionLabel="label"
                optionValue="value"
                placeholder="Default Library"
                [(ngModel)]="defaultLibraryId">
              </p-select>

              <p-select
                size="small"
                [options]="selectedLibraryPaths"
                optionLabel="label"
                optionValue="value"
                placeholder="Default Subpath"
                [(ngModel)]="defaultPathId">
              </p-select>

              <p-button
                size="small"
                label="Apply"
                icon="pi pi-check"
                [disabled]="!canApplyDefaults"
                (click)="applyDefaultsToAll()"
                pTooltip="Apply selected library and subpath to all files"
                tooltipPosition="top">
              </p-button>
            </div>
          </div>
        }
      </div>

      <div class="content-area">
        @if (bookdropFileUis.length === 0) {
          <div class="empty-state">
            No bookdrop files to review.
          </div>
        } @else {
          @for (file of bookdropFileUis; track file) {

            <div class="file-item">
              <div class="file-row">

                <p-checkbox
                  [binary]="true"
                  [(ngModel)]="file.selected"
                  (ngModelChange)="toggleFileSelection(file.file.id, $event)">
                </p-checkbox>

                <i
                  class="pi pi-circle-fill status-indicator"
                  [ngStyle]="{'color': file.file.fetchedMetadata ? 'green' : 'darkorange'}"
                  pTooltip="{{file.file.fetchedMetadata ? 'Fetched metadata is available.' : 'No fetched metadata available.'}}"
                  tooltipPosition="top">
                </i>

                @if (file.metadataForm.get('thumbnailUrl')?.value) {
                  <img
                    [src]="file.metadataForm.get('thumbnailUrl')?.value"
                    alt="Cover"
                    title="Original cover"
                    class="cover-image"
                    (click)="file.showDetails = !file.showDetails"/>
                }

                @if (file.file.fetchedMetadata?.thumbnailUrl) {
                  <img
                    [src]="file.file.fetchedMetadata?.thumbnailUrl"
                    alt="Fetched Cover"
                    title="Fetched cover"
                    class="cover-image"
                    (click)="file.showDetails = !file.showDetails"/>
                }

                <div class="file-name" (click)="file.showDetails = !file.showDetails">
                  {{ file.file.fileName }}
                </div>

                <i
                  class="pi metadata-status"
                  [ngClass]="{
                  'pi-check-circle copied': copiedFlags[file.file.id],
                  'pi-check-circle no-metadata': !file.file.fetchedMetadata,
                  'pi-exclamation-triangle not-applied': file.file.fetchedMetadata && !copiedFlags[file.file.id]
                }"
                  [pTooltip]="copiedFlags[file.file.id]
                  ? 'Fetched metadata has been applied.'
                  : (!file.file.fetchedMetadata || !file.file.fetchedMetadata.title)
                    ? 'No fetched metadata available. Original metadata will be used.'
                    : 'Fetched metadata hasnâ€™t been applied yet. Open metadata picker to review.'"
                  tooltipPosition="top">
                </i>

                <p-select
                  size="small"
                  [options]="libraryOptions"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Select Library"
                  class="library-select"
                  [(ngModel)]="file.selectedLibraryId"
                  (onChange)="onLibraryChange(file)">
                </p-select>

                <p-select
                  size="small"
                  [options]="file.availablePaths"
                  optionLabel="name"
                  optionValue="id"
                  placeholder="Select Subpath"
                  class="path-select"
                  appendTo="body"
                  [(ngModel)]="file.selectedPathId">
                </p-select>

                <p-button
                  size="small"
                  [icon]="file.showDetails ? 'pi pi-chevron-up' : 'pi pi-chevron-down'"
                  (click)="file.showDetails = !file.showDetails"
                  tooltipPosition="top">
                </p-button>
              </div>

              @if (file.showDetails) {
                <app-bookdrop-file-metadata-picker-component
                  class="details-section"
                  [originalMetadata]="file.file.originalMetadata"
                  [fetchedMetadata]="file.file.fetchedMetadata!"
                  [metadataForm]="file.metadataForm"
                  [copiedFields]="file.copiedFields"
                  [savedFields]="file.savedFields"
                  [bookdropFileId]="file.file.id"
                  (metadataCopied)="onMetadataCopied(file.file.id, $event)">
                </app-bookdrop-file-metadata-picker-component>
              }
            </div>
          }
        }
      </div>

      <p-divider></p-divider>

      <div class="footer">

        <div class="footer-left">
          @if (bookdropFileUis.length > 0) {
            <p-button
              label="Select&nbsp;All"
              icon="pi pi-check-square"
              severity="info"
              (click)="selectAll(true)"
              outlined
              pTooltip="Select all files across all pages you have navigated"
              tooltipPosition="top">
            </p-button>

            <p-button
              label="Clear"
              icon="pi pi-times-circle"
              severity="warn"
              (click)="selectAll(false)"
              outlined
              pTooltip="Deselect all files across all pages you have navigated"
              tooltipPosition="top">
            </p-button>
          } @else {
            <div class="spacer"></div>
          }
        </div>

        <div class="footer-center">
          <p-paginator
            [rows]="pageSize"
            [totalRecords]="totalRecords"
            [first]="currentPage * pageSize"
            (onPageChange)="loadPage($event.page ?? 0)"
            [showJumpToPageDropdown]="true"
            [showPageLinks]="false"
            [showFirstLastIcon]="false"
            currentPageReportTemplate="Page {currentPage} of {totalPages}">
          </p-paginator>
        </div>

        <div class="footer-right">
          <p-button
            [label]="'Reset ' + selectedCount"
            icon="pi pi-refresh"
            severity="warn"
            [disabled]="!hasSelectedFiles"
            outlined
            (click)="confirmReset()"
            pTooltip="Discard all changes made to metadata of selected files"
            tooltipPosition="top">
          </p-button>
          <p-button
            [label]="'Delete ' + selectedCount"
            icon="pi pi-times"
            severity="danger"
            [disabled]="!hasSelectedFiles"
            outlined
            (click)="confirmDelete()"
            pTooltip="Permanently delete selected Bookdrop files and discard any changes"
            tooltipPosition="top">
          </p-button>
          <p-button
            [label]="saving ? ('Finalizing ' + selectedCount + '...') : ('Finalize ' + selectedCount)"
            [icon]="saving ? 'pi pi-spin pi-spinner' : 'pi pi-save'"
            severity="success"
            outlined
            [disabled]="!canFinalize || saving"
            (click)="confirmFinalize()"
            pTooltip="Move selected files into the chosen library and subpath">
          </p-button>
        </div>

      </div>
    }
  </div>
</div>
